unit obj_MM_form;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtDlgs,
  System.ImageList, Vcl.ImgList, Vcl.Menus, FileCtrl, Vcl.Buttons, Vcl.ExtCtrls;

type
  TObj_MM = class(TForm)
    object_name: TLabel;
    Make: TButton;
    Open_photo: TOpenPictureDialog;
    destlock: TLabel;
    ScrollBox1: TScrollBox;
    RenameButton: TButton;
    procedure OpenFile1Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormShow(Sender: TObject);
    procedure FormMouseWheelDown(Sender: TObject; Shift: TShiftState;
      MousePos: TPoint; var Handled: Boolean);
    procedure FormMouseWheelUp(Sender: TObject; Shift: TShiftState;
      MousePos: TPoint; var Handled: Boolean);
    procedure PhotoInputCreate(index, topBtn, topLabel: integer; pr_pan: TWinControl; btnText, keId: string);
    procedure RenameButtonClick(Sender: TObject);
    procedure CreateParams(var Params: TCreateParams); override;
  private
    { Private declarations }
  public
    { Public declarations }

  end;

var
  obj_MM: Tobj_MM;
  Cash_Panel: TPanel;
  Uks_Panel: TPanel;
  Other_panel: TPanel;
  Down_panel: TPanel;
  OpenFileBtn: TBitBtn;
  Gen_btn: TButton;
  FlocLb : TLabel;

implementation

  uses obj_select_form;

{$R *.dfm}

procedure TObj_MM.CreateParams (var Params: TCreateParams);
begin
inherited CreateParams(Params);
  Params.WndParent:= GetDesktopWindow; // дочерняя форма рабочего стола
end;

procedure TObj_MM.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  obj_sel_form.Close;
end;

procedure TObj_MM.FormMouseWheelDown(Sender: TObject; Shift: TShiftState;
  MousePos: TPoint; var Handled: Boolean);
begin
  with scrollBox1.VertScrollBar do
   Position := Position + Increment;
end;

procedure TObj_MM.FormMouseWheelUp(Sender: TObject; Shift: TShiftState;
  MousePos: TPoint; var Handled: Boolean);
begin
  with scrollBox1.VertScrollBar do
   Position := Position - Increment;
end;

procedure TObj_MM.FormShow(Sender: TObject);
var
  n, t, a, m, x, y, u, u1, index: integer;
  //где n - для касс, t - для тсд, a - для ТД, m - для МП, x и y для определения точки отсчета компонента, относительно предыдущего
begin
  obj_MM.Caption := 'Форма отчета для ' + obj_select_form.Report.Rtype;
  index := 0;
  for n := 1 to obj_select_form.Report.Cashcount do
  begin
    Cash_Panel:= TPanel.Create(obj_MM);
    Cash_Panel.Parent := ScrollBox1;
    Cash_Panel.Name := 'BtnBlock' + IntToStr(n);
    Cash_Panel.Caption := '';
    Cash_Panel.Left := 0;
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    Cash_Panel.Height := 560;
    end
    else
    Cash_Panel.Height := 524;
    Cash_Panel.Width := 810;
    Cash_Panel.Top := Cash_Panel.Height *(n-1);
    //Панелька с кнопками для касс
    //Кнопка 1
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    PhotoInputCreate(index, 10, 15, Cash_Panel, cash +' '+ IntToStr(n)+' ' + inside, '');
    index := index + 1;
    end
    else
    PhotoInputCreate(index, 10, 15, Cash_Panel, cash +' '+ IntToStr(n)+' ' + insidemk, '');
    index := index + 1;

    //Кнопка 2
    PhotoInputCreate(index, 46, 52, Cash_Panel, cash +' '+ IntToStr(n)+' ' + allviewitems, '');
    index := index + 1;
    //Кнопка 3
    PhotoInputCreate(index, 82, 89, Cash_Panel, cash +' '+ IntToStr(n)+' ' + ibpmark, '');
    index := index + 1;

    //Кнопка 4
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    PhotoInputCreate(index, 118, 125, Cash_Panel, cash +' '+ IntToStr(n)+' ' + sksmount, '');
    index := index + 1;
    end
    else
    PhotoInputCreate(index, 118, 125, Cash_Panel, cash +' '+ IntToStr(n)+' ' + allitemsmark, '');
    index := index + 1;

    //Кнопка 5
    PhotoInputCreate(index, 154, 162, Cash_Panel, cash +' '+ IntToStr(n)+' ' + kkt, '');
    index := index + 1;
    //Кнопка 6
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    PhotoInputCreate(index, 190, 197, Cash_Panel, cash +' '+ IntToStr(n)+' ' + check, '');
    index := index + 1;
    end
    else
    PhotoInputCreate(index, 190, 197, Cash_Panel, cash +' '+ IntToStr(n)+' ' + checkmk, '');
    index := index + 1;

    //Кнопка 7
    PhotoInputCreate(index, 226, 233, Cash_Panel, cash +' '+ IntToStr(n)+' ' + allview, '');
    index := index + 1;
    //Кнопка 8
    PhotoInputCreate(index, 262, 270, Cash_Panel, cash +' '+ IntToStr(n)+' ' + allviewbuyer, '');
    index := index + 1;
    //Кнопка 9
    PhotoInputCreate(index, 298, 306, Cash_Panel, cash +' '+ IntToStr(n)+' ' + ke + ' '+ pc, '1');
    index := index + 1;
    //Кнопка 10
    PhotoInputCreate(index, 334, 342, Cash_Panel, cash +' '+ IntToStr(n)+' ' + ke+ ' '+ ibp, '1');
    index := index + 1;
    //Кнопка 11
    PhotoInputCreate(index, 370, 378, Cash_Panel, cash +' '+ IntToStr(n)+' ' + ke +' '+ pinpad, '1');
    index := index + 1;
    //Кнопка 12
    PhotoInputCreate(index, 406, 414, Cash_Panel, cash +' '+ IntToStr(n)+' ' + ke + ' '+ scan, '1');
    index := index + 1;
    //Кнопка 13
    PhotoInputCreate(index, 442, 450, Cash_Panel, cash +' '+ IntToStr(n)+' ' + ke + ' ' + hand, '1');
    index := index + 1;
    //Кнопка 14
    PhotoInputCreate(index, 478, 486, Cash_Panel, cash +' '+ IntToStr(n)+' ' + ke + ' ' + kkt, '1');
    index := index + 1;
    //Кнопка 15
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    PhotoInputCreate(index, 514, 522, Cash_Panel, cash +' '+ IntToStr(n)+' ' + ke + ' ' + scales, '1');
    index := index + 1;
    end;


  end;

    //Панель для фото УКС
    Uks_Panel:= TPanel.Create(obj_MM);
    Uks_Panel.Parent := ScrollBox1;
    Uks_Panel.Name := 'BtnBlock_uks';
    Uks_Panel.Caption := '';
    Uks_Panel.Top := Cash_Panel.Height *(n-1);
    Uks_Panel.Left := 0;
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    Uks_Panel.Height := 985;
    end
    else
    Uks_Panel.Height := 949;
    Uks_Panel.Width := 810;

    u := 10;
    u1 := 15;
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    //Кнопка 1
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+pcdir, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 2
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+pcserv, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    end
    else
    begin
    //Кнопка 1
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+pcdirmk, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 2
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+pcservmk, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    end;
    //Кнопка 3
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+egais, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    end;
    //Кнопка 4
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+rout, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 5
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+hub, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 6
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+hubtd, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 7
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+bpmark, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка маркировка БП2 для МК
    if obj_select_form.Report.Rtype = 'MK' then
    begin
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+bpmark + ' 2', '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    end;
    //Кнопка 8
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+allviewb, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 9
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+allviewf, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 10
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+allviewm, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    end
    else
    begin
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+allview + ' 1', '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 9
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+allview + ' 2', '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 10
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+allview + ' 3' , '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    end;
    //Кнопка 11
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+swith, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    end
    else
    begin
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+allviewbuyer, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    end;
    //Кнопка 12
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+wifi + ' (WiFi)', '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 13
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+a4prt, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 14
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+a4prt+' подключение', '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 15
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+testpage, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 16
    PhotoInputCreate(index, u, u1, Uks_Panel, nut, '');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 17
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+ pcdirmk + ' ' + ke, '1');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 18
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+ ibp + ' ' + pcdirmk+ ' ' + ke, '1');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 19
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+ pc + ' ' + pcservmk + ' ' + ke, '1');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 20
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' '+ ibp + ' ' + pcservmk + ' ' + ke, '1');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 21
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' ' + mon19 + ' ' +ke, '1');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 22
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' ' + wifi + ' '+ ke, '1');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 23
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' ' + a4prt + ' '+ ke, '1');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 24
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' ' + a4scan + ' ' + ke, '1');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 25
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' ' + master + ' ' +ke, '1');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 26
    PhotoInputCreate(index, u, u1, Uks_Panel, uks+' ' + reserv + ' ' + ke, '1');
    index := index + 1;
    u:= u +36;
    u1 := u1 + 36;
    //Кнопка 27
    if obj_select_form.Report.Rtype = 'MM' then
    begin
    PhotoInputCreate(index, u, u1, Uks_Panel, floor_scales + ' ' + ke, '1');
    index := index + 1;
    end;

    //Панель для прочего
    Other_Panel:= TPanel.Create(obj_MM);
    Other_Panel.Parent := ScrollBox1;
    Other_Panel.Name := 'BtnBlock_other';
    Other_Panel.Caption := '';
    Other_Panel.Top := Uks_Panel.Height + Cash_Panel.Height *(n-1);
    Other_Panel.Left := 0;
    Other_Panel.Height := (3 + Report.tsdcount*2 + Report.apcount*3 + Report.mpcount*3)*36+15 ;
    Other_Panel.Width := 810;

    //Кнопка
    PhotoInputCreate(index, 10, 15, Other_panel, plan, '');
    index := index + 1;
    //Кнопка
    PhotoInputCreate(index, 46, 52, Other_panel, chklst + ' 1', '');
    index := index + 1;
    //Кнопка
    PhotoInputCreate(index, 82, 89, Other_panel, chklst + ' 2','');
    index := index + 1;

    //Кнопки ТСД
    for t := 1 to Report.tsdcount do
    begin
    PhotoInputCreate(index, 118+72*(t-1), 125+72*(t-1), Other_panel, tsd+IntToStr(t)+' '+ view, '');
    index := index + 1;
    PhotoInputCreate(index, 154+72*(t-1), 162+72*(t-1), Other_panel, tsd+IntToStr(t)+' '+ ke, '1');
    index := index + 1;
    end;
    x :=  118+72*(t-1);
    y :=  125+72*(t-1);
    //Кнопки МП
    for m := 1 to Report.mpcount do
    begin
    PhotoInputCreate(index, x+108*(m-1), y+108*(m-1), Other_panel, mp+IntToStr(m)+' '+ view, '');
    index := index + 1;
    PhotoInputCreate(index, x+36+108*(m-1), y+36+108*(m-1), Other_panel, mp+IntToStr(m)+' '+ prt, '');
    index := index + 1;
    PhotoInputCreate(index, x+72+108*(m-1), y+72+108*(m-1), Other_panel, mp+IntToStr(m)+' '+ ke, '1');
    index := index + 1;
    end;
    x := x+108*(m-1);
    y := y+108*(m-1);
    //Кнопки ТД
    for a := 1 to Report.apcount do
    begin
    PhotoInputCreate(index, x+108*(a-1), y+108*(a-1), Other_panel, ap+IntToStr(a)+' '+ mark, '');
    index := index + 1;
    PhotoInputCreate(index, x+36+108*(a-1), y+36+108*(a-1), Other_panel, ap+IntToStr(a)+' '+ install, '');
    index := index + 1;
    PhotoInputCreate(index, x+72+108*(a-1), y+72+108*(a-1), Other_panel, ap+IntToStr(a)+' '+ ke, '1');
    index := index + 1;
    end;

end;

procedure TObj_MM.PhotoInputCreate(index, topBtn, topLabel: integer; pr_pan: TWinControl; btnText, keId: string);
begin
  //Кнопки панели Касс
  OpenFileBtn:= TBitBtn.Create(obj_MM);
  OpenFileBtn.Parent := pr_pan;
  OpenFileBtn.Name := 'OpenFile' + IntToStr(index);
  OpenFileBtn.Caption := btnText;
  OpenFileBtn.Top := topBtn;
  OpenFileBtn.Left := 15;
  OpenFileBtn.Height := 30;
  OpenFileBtn.Width := 280;
  OpenFileBtn.Margin := 0;
  OpenFileBtn.Font.Height := 0;
  OpenFileBtn.Glyph.LoadFromFile('files/add_file_30x30.bmp');
  OpenFileBtn.Font.Name := 'Times New Roman';
  OpenFileBtn.Tag := index;
  OpenFileBtn.onClick := OpenFile1Click;

  obj_select_form.Report.photos[index + 1, 1] := OpenFileBtn.Caption; // Записываем в массив объекта отчета название для фото
  obj_select_form.Report.photos[index + 1, 3] := keId; // Записываем в массив объекта отчета признак КЕ

    //Лейбл пути файла
  FlocLb:= TLabel.Create(obj_MM);
  FlocLb.Parent := pr_pan;
  FlocLb.Name := 'Floc' + IntToStr(index);
  FlocLb.Caption := '..';
  FlocLb.Top := topLabel;
  FlocLb.Left := 310;
  FlocLb.Height := 30;
  FlocLb.Font.Name := 'System';
end;

procedure TObj_MM.RenameButtonClick(Sender: TObject);
var MainDir: string;
 item, properti: integer;
begin
  MainDir := obj_select_form.Report.Dlock + '\' + obj_select_form.Report.OOname;
  if CreateDir(MainDir) then // Создаем папку с названием магазина
  begin
    CreateDir(MainDir + '\' + ke); // Создаем папку для КЕ
    for item := 1 to 200 do  // Пребираем массив с данными о фото
    begin
      for properti := 1 to 3 do
      begin

        if obj_select_form.Report.photos[item, 1] <> '' then // Если первое значение не пустое, значит есть данные о фото
          if obj_select_form.Report.photos[item, 3] = '' then // Если признак КЕ пустой значит кладем фото в корневую папку
            CopyFile(PChar(obj_select_form.Report.photos[item, 2]), PChar(MainDir + '\' + obj_select_form.Report.photos[item, 1] + '.jpg'), false)
          else // Если признак КЕ не пустой значит кладем фото в папку КЕ
            CopyFile(PChar(obj_select_form.Report.photos[item, 2]), PChar(MainDir + '\' + ke+ '\'  + obj_select_form.Report.photos[item, 1] + '.jpg'), false)
      end;
    end;
    ShowMessage('Отчет успешно сформирован');
  end
  else
   ShowMessage('Ошибка: папка не создана. Папка уже существует или нет доступа к файловой системе.');
end;

procedure TObj_MM.OpenFile1Click(Sender: TObject);
var btnID: integer;
begin
  btnID := TButton(Sender).Tag; // Здесь получаем id кнопки на которую нажали
  if Open_photo.Execute then
    begin
      (FindComponent('Floc' + IntToStr(btnID)) as TLabel).Caption := Open_photo.FileName;// Ищем соседний с кнопкой лейбл и выводим в него путь к файлу
      TBitBtn(Sender).Glyph.LoadFromFile('files/add_file_30x30checked.bmp'); // Мнячем иконку на кнопке
      obj_select_form.Report.photos[TButton(Sender).Tag + 1, 2] := Open_photo.FileName; // Записываем в массив объекта отчета путь для фото
    end;
end;

end.
